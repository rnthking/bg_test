name: Python application with Feishu Notifications

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

permissions:
  contents: read

jobs:
  build-and-notify:
    runs-on: ubuntu-latest

    env:  # å®šä¹‰å…¨å±€ç¯å¢ƒå˜é‡
      FEISHU_WEBHOOK: "https://open.feishu.cn/open-apis/bot/v2/hook/74ea8fdc-be23-4600-ab39-2fe2cb118bd5"

    steps:
      - name: Get current time
        id: get-time
        run: echo "current_time=$(date '+%Y-%m-%d %H:%M:%S')" >> $GITHUB_ENV
      
      - name: Check out code
        uses: actions/checkout@v4

      - name: Get changed files
        id: changed-files
        uses: tj-actions/changed-files@v39
      
      - name: check changed files
        if: contains(steps.changed-files.outputs.all_changed_files, 'main.py')
        run: echo " main.py changed ğŸš€ğŸš€"

      # è·å–æäº¤æ—¥å¿—
      - name: Get Git Commit Log
        id: git_log
        run: |
          echo "git_log=$(git log -1 --pretty=format:'%s')" >> $GITHUB_ENV

      - name: Set up Python 3.9
        uses: actions/setup-python@v3
        with:
          python-version: "3.9"

      - name: Restore pipenv cache
        uses: actions/cache@v3
        id: cache-pipenv
        with:
          path: ~/.local/share/virtualenvs
          key: ${{ runner.os }}-pipenv-${{ hashFiles('**/Pipfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pipenv-

      - name: Install pipenv
        run: |
          pip install --user pipenv

      - name: Add pipenv to PATH
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH

      - name: Install dependencies
        run: |
          pipenv install --dev  # è‡ªåŠ¨è¿‡æ»¤å·²æ»¡è¶³çš„ä¾èµ–

      - name: Run tests with pytest
        id: pytest  # é€šè¿‡ ID è®°å½•æ­¤æ­¥éª¤çš„ç»“æœ
        run: |
          pipenv run pytest

      # æµ‹è¯•æˆåŠŸé€šçŸ¥é£ä¹¦
      - name: Notify Feishu (success)
        if: success()  # ä»…åœ¨æ‰€æœ‰å‰ç½®æ­¥éª¤æˆåŠŸæ—¶æ‰§è¡Œ
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "âœ… å‘ç‰ˆæˆåŠŸï¼"
                  },
                  "template": "green"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "å‘ç‰ˆæ—¶é—´:${{ env.current_time }}\næ›´æ–°åŠŸèƒ½: ${{env.git_log}}\nåˆ†æ”¯:${{ github.ref_name }}\næäº¤: [æŸ¥çœ‹æäº¤çš„commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\nå‘ç‰ˆ: [æŸ¥çœ‹GithubAction](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\nç½‘å€: https://app.ithinkai.cn\næµ‹è¯•äººå‘˜: @å½±çŒ«"
                    }
                  }
                ]
              }
            }' \
            $FEISHU_WEBHOOK

      # å‘ç‰ˆå¤±è´¥
      - name: Notify Feishu (failure)
        if: failure()  # ä»…åœ¨ä»»æ„æ­¥éª¤å¤±è´¥æ—¶æ‰§è¡Œ
        run: |
          curl -X POST \
            -H "Content-Type: application/json" \
            -d '{
              "msg_type": "interactive",
              "card": {
                "config": {
                  "wide_screen_mode": true
                },
                "header": {
                  "title": {
                    "tag": "plain_text",
                    "content": "âŒ å‘ç‰ˆå¤±è´¥ï¼"
                  },
                  "template": "red"
                },
                "elements": [
                  {
                    "tag": "div",
                    "text": {
                      "tag": "lark_md",
                      "content": "å‘ç‰ˆæ—¶é—´:${{ env.current_time }}\næ›´æ–°åŠŸèƒ½:${{env.git_log}}\nåˆ†æ”¯:${{ github.ref_name }}\næäº¤: [æŸ¥çœ‹æäº¤çš„commit](https://github.com/${{ github.repository }}/commit/${{ github.sha }})\nå‘ç‰ˆ: [æŸ¥çœ‹GithubAction](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})\nç½‘å€: https://app.ithinkai.cn\næµ‹è¯•äººå‘˜: @é£é¹°"
                    }
                  }
                ]
              }
            }' \
            $FEISHU_WEBHOOK
